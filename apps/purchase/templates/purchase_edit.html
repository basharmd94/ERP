{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}{% trans "Purchase GRN Edit" %}{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/select2/select2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/flatpickr/flatpickr.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/bootstrap-datepicker/bootstrap-datepicker.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/sweetalert2/sweetalert2.css' %}" />
<link rel="stylesheet" href="{% static 'vendor/libs/toastr/toastr.css' %}" />
<link rel="stylesheet" href="{% static 'css/vertical_cart_layout.css' %}" />
{% endblock vendor_css %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/select2/select2.js' %}"></script>
<script src="{% static 'vendor/libs/flatpickr/flatpickr.js' %}"></script>
<script src="{% static 'vendor/libs/bootstrap-datepicker/bootstrap-datepicker.js' %}"></script>
<script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
<script src="{% static 'vendor/libs/moment/moment.js' %}"></script>
<script src="{% static 'vendor/libs/sweetalert2/sweetalert2.js' %}"></script>
<script src="{% static 'vendor/libs/toastr/toastr.js' %}"></script>
{% endblock vendor_js %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="javascript:void(0);">Purchase</a></li>
    <li class="breadcrumb-item active">Edit GRN</li>
    <li class="breadcrumb-item"><a href="{% url 'po-confirmed-list' %}">PO List</a></li>
  </ol>
</nav>

<div class="card-body">
  <form id="po-edit-entry-form">
    <div class="row po-create-container">
      <div class="col-md-5">
        <div class="card border-primary mb-3">
          <div class="card-header bg-primary text-white">
            <h6 class="card-title text-white mb-0"><i class="fas fa-edit me-2"></i>GRN Details</h6>
          </div>
          <div class="card-body">
            <div class="row mt-2">
              <div class="col-md-6 mb-2">
                <label class="form-label">GRN Number</label>
                <input type="text" class="form-control" id="grn-number" value="{{ transaction_id }}" readonly />
              </div>
              <div class="col-md-6 mb-2">
                <label for="transaction-date" class="form-label">Date</label>
                <input type="text" class="form-control" id="transaction-date" placeholder="Select date" readonly />
              </div>
              <div class="col-md-6 mb-2">
                <label for="supplierSelect" class="form-label">Supplier Number</label>
                <input type="text" class="form-control" id="supplierSelect" readonly />
              </div>
              <div class="col-md-6 mb-2">
                <label for="warehouse" class="form-label">Warehouse</label>
                <input type="text" class="form-control" id="warehouse" />
              </div>
              <div class="col-md-12 mb-2">
                <label for="project" class="form-label">Project</label>
                <input type="text" class="form-control" id="project" />
              </div>
              <div class="col-md-6 mb-2">
                <label for="discount-percent" class="form-label">Discount %</label>
                <input type="number" class="form-control" id="discount-percent" placeholder="0.00" step="0.01" min="0" max="100" />
              </div>
              <div class="col-md-6 mb-2">
                <label for="fixed-discount" class="form-label">Fixed Discount</label>
                <input type="number" class="form-control" id="fixed-discount" placeholder="0.00" step="0.01" min="0" />
              </div>
              <div class="col-12 mb-2">
                <label for="notes" class="form-label">Notes</label>
                <textarea class="form-control" id="notes" rows="2" placeholder="Enter notes"></textarea>
              </div>
            </div>
            <div class="col-12 mb-3">
              <label for="entered-by" class="form-label">Entered by</label>
              <input type="text" class="form-control border-none" id="entered-by" value="{{ user.username }}" readonly />
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-7 cart-column">
        <div class="cart-section-wrapper">
          <div id="empty-cart-message" class="text-center py-5" style="display:none;">
            <div class="card border-light">
              <div class="card-body">
                <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No items</h5>
                <p class="text-muted">Load existing GRN items to edit</p>
              </div>
            </div>
          </div>
          <div id="cart-section">
            <div class="card border-success">
              <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="card-title text-white mb-0"><i class="fas fa-shopping-cart me-2"></i>GRN Items (<span id="cart-items-count">0</span>)</h6>
                <button type="button" class="btn btn-sm btn-outline-light" id="add-row"><i class="fas fa-plus me-1"></i>Add Row</button>
              </div>
              <div class="card-body p-0">
                <div class="card-datatable table-responsive">
                  <table id="cart-datatable" class="datatables-cart table table-hover">
                    <thead>
                      <tr>
                        <th class="w-5 text-center">Sl</th>
                        <th class="w-20 text-start">Item Code</th>
                        <th class="w-25 text-start">Item Name</th>
                        <th class="w-10 text-start">Qty</th>
                        <th class="w-15 text-start">Rate</th>
                        <th class="w-15 text-center">Line Amount</th>
                        <th class="w-10 text-center">Action</th>
                      </tr>
                    </thead>
                    <tbody id="cart-items-tbody"></tbody>
                  </table>
                </div>
                <div class="card-footer bg-light">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="d-flex justify-content-between"><span class="fw-bold">Total Items:</span><span id="cart-total-items" class="text-primary fw-bold">0.00</span></div>
                    </div>
                    <div class="col-md-6">
                      <div class="d-flex justify-content-between"><span class="fw-bold">Total Amount:</span><span id="cart-total-amount" class="text-success fw-bold fs-5">৳0.00</span></div>
                    </div>
                  </div>
                  <div class="row mt-2">
                    <div class="col-md-6"><div class="d-flex justify-content-between"><span class="fw-bold">Discount:</span><span id="cart-total-discount" class="text-danger fw-bold">৳0.00</span></div></div>
                    <div class="col-md-6"><div class="d-flex justify-content-between"><span class="fw-bold">Net Amount:</span><span id="cart-net-amount" class="text-info fw-bold fs-5">৳0.00</span></div></div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-md-12 text-end">
                      <button type="button" class="btn btn-success" id="update-grn"><i class="fas fa-check me-1"></i>Update GRN</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block custom_api_js %}
<script>
const grnNumber = '{{ transaction_id }}';

function numberFormat(n){return (Math.round(parseFloat(n || 0) * 100) / 100).toFixed(2)}
function recalcTotals(){
  const rows = document.querySelectorAll('#cart-items-tbody tr');
  let items = 0, amount = 0;
  rows.forEach(r => {items += 1; amount += parseFloat(r.querySelector('.line-amount').textContent || '0')});
  const discPct = parseFloat(document.getElementById('discount-percent').value || '0');
  const discFix = parseFloat(document.getElementById('fixed-discount').value || '0');
  const discAmt = (amount * discPct / 100.0) + discFix;
  const net = amount - discAmt;
  document.getElementById('cart-items-count').textContent = items;
  document.getElementById('cart-total-items').textContent = numberFormat(items);
  document.getElementById('cart-total-amount').textContent = '৳' + numberFormat(amount);
  document.getElementById('cart-total-discount').textContent = '৳' + numberFormat(discAmt);
  document.getElementById('cart-net-amount').textContent = '৳' + numberFormat(net);
}

function addRow(it){
  const tbody = document.getElementById('cart-items-tbody');
  const idx = tbody.children.length + 1;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="text-center">${idx}</td>
    <td><input type="text" class="form-control form-control-sm item-code" value="${it?.xitem || ''}"></td>
    <td>${it?.xdesc || ''}</td>
    <td><input type="number" step="0.01" class="form-control form-control-sm qty" value="${it?.xqty ?? 0}"></td>
    <td><input type="number" step="0.01" class="form-control form-control-sm rate" value="${it?.xrate ?? 0}"></td>
    <td class="text-center line-amount">${numberFormat((it?.xqty || 0) * (it?.xrate || 0))}</td>
    <td class="text-center"><button class="btn btn-sm btn-outline-danger remove-row">Remove</button></td>
  `;
  tbody.appendChild(tr);
  tr.querySelector('.qty').addEventListener('input', () => {tr.querySelector('.line-amount').textContent = numberFormat(parseFloat(tr.querySelector('.qty').value||0) * parseFloat(tr.querySelector('.rate').value||0));recalcTotals()});
  tr.querySelector('.rate').addEventListener('input', () => {tr.querySelector('.line-amount').textContent = numberFormat(parseFloat(tr.querySelector('.qty').value||0) * parseFloat(tr.querySelector('.rate').value||0));recalcTotals()});
  tr.querySelector('.remove-row').addEventListener('click', (e) => {e.preventDefault(); tr.remove(); recalcTotals()});
}

document.getElementById('add-row').addEventListener('click', (e)=>{e.preventDefault(); addRow({xqty:0,xrate:0})});
document.getElementById('fixed-discount').addEventListener('input', recalcTotals);
document.getElementById('discount-percent').addEventListener('input', recalcTotals);

async function loadGRN(){
  const resp = await fetch(`/purchase/po-grn-get/${grnNumber}/`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
  const data = await resp.json();
  if(!data.success){ Swal.fire('Error', data.message || 'Failed to load', 'error'); return; }
  const h = data.header;
  if(h.xstatusgrn !== '1-Open'){ Swal.fire('Locked', 'Only open GRN can be edited', 'warning'); }
  document.getElementById('transaction-date').value = h.xdate || '';
  document.getElementById('supplierSelect').value = h.xsup || '';
  document.getElementById('warehouse').value = h.xwh || '';
  document.getElementById('project').value = h.xproj || '';
  document.getElementById('discount-percent').value = h.xdisc || 0;
  document.getElementById('fixed-discount').value = h.xdtdisc || 0;
  document.getElementById('notes').value = h.xrem || '';
  const tbody = document.getElementById('cart-items-tbody');
  tbody.innerHTML = '';
  (data.details || []).forEach(addRow);
  recalcTotals();
}

async function updateGRN(){
  const header = {
    xdate: document.getElementById('transaction-date').value,
    xsup: document.getElementById('supplierSelect').value,
    xwh: document.getElementById('warehouse').value,
    xproj: document.getElementById('project').value,
    xdisc: document.getElementById('discount-percent').value,
    xdtdisc: document.getElementById('fixed-discount').value,
    xrem: document.getElementById('notes').value,
  };
  const details = [];
  document.querySelectorAll('#cart-items-tbody tr').forEach((tr, i)=>{
    details.push({
      xrow: i+1,
      xitem: tr.querySelector('.item-code').value,
      xqty: tr.querySelector('.qty').value,
      xrate: tr.querySelector('.rate').value,
    })
  });
  const resp = await fetch(`/purchase/po-grn-update/${grnNumber}/`, {
    method:'POST',
    headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest','X-CSRFToken': (document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')||[])[2]},
    body: JSON.stringify({header, details})
  });
  const data = await resp.json();
  if(!data.success){ Swal.fire('Error', data.message || 'Update failed', 'error'); return; }
  toastr.success('GRN updated');
  setTimeout(()=>{ window.location.href = `/purchase/po-grn-detail/${grnNumber}/`; }, 800);
}

document.getElementById('update-grn').addEventListener('click', (e)=>{e.preventDefault(); updateGRN()});
document.addEventListener('DOMContentLoaded', loadGRN);
</script>
{% endblock custom_api_js %}

